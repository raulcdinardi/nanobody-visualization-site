<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Antibody Design - Interactive Data Table</title>

    <!-- D3.js for data manipulation -->
    <script src="https://d3js.org/d3.v7.min.js"></script>

    <!-- NGL Viewer for 3D molecule figure -->
    <script src="https://cdn.jsdelivr.net/gh/arose/ngl@v2.0.0-dev.37/dist/ngl.js"></script>


    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --bg-color: #f9fafb;
            --card-bg: #ffffff;
            --text-primary: #111827;
            --text-secondary: #6b7280;
            --text-muted: #9ca3af;
            --border-color: #e5e7eb;
            --border-hover: #d1d5db;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            --radius: 12px;
            --radius-lg: 16px;
            --hover-bg: #f8fafc;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-primary);
            padding: 40px 20px;
            line-height: 1.5;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        h1 {
            font-size: 36px;
            font-weight: 700;
            margin-bottom: 16px;
            color: var(--text-primary);
            letter-spacing: -0.02em;
            text-align: center;
        }

        .subtitle {
            color: var(--text-secondary);
            margin-bottom: 40px;
            font-size: 18px;
            font-weight: 400;
            text-align: center;
            max-width: 800px;
            margin-left: auto;
            margin-right: auto;
        }

        .hero-section {
            text-align: center;
            margin-bottom: 60px;
            padding: 40px 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 24px;
            color: white;
            margin-bottom: 60px;
        }

        .hero-section h1 {
            color: white;
            font-size: 42px;
            margin-bottom: 16px;
        }

        .hero-section .subtitle {
            color: rgba(255, 255, 255, 0.9);
            font-size: 20px;
            margin-bottom: 0;
        }

        .hero-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 40px;
        }

        .hero-stat {
            background: rgba(255, 255, 255, 0.15);
            padding: 20px;
            border-radius: 16px;
            backdrop-filter: blur(10px);
        }

        .hero-stat-number {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .hero-stat-label {
            font-size: 14px;
            opacity: 0.9;
        }

        .content-section {
            margin-bottom: 60px;
        }

        .section-title {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 16px;
            color: var(--text-primary);
        }

        .section-description {
            color: var(--text-secondary);
            font-size: 16px;
            margin-bottom: 32px;
            line-height: 1.6;
        }

        .plots-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 32px;
            margin-bottom: 40px;
        }

        .plot-card {
            background: var(--card-bg);
            border-radius: var(--radius-lg);
            padding: 24px;
            border: 1px solid var(--border-color);
            box-shadow: var(--shadow-md);
        }

        .plot-card img {
            width: 100%;
            height: auto;
            border-radius: var(--radius);
            margin-bottom: 16px;
        }

        .plot-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .plot-description {
            color: var(--text-secondary);
            font-size: 14px;
        }

        .top-designs {
            background: var(--card-bg);
            border-radius: var(--radius-lg);
            padding: 32px;
            border: 1px solid var(--border-color);
            box-shadow: var(--shadow-md);
            margin-bottom: 40px;
        }

        .designs-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 24px;
            margin-top: 24px;
        }

        .design-card {
            background: #f8fafc;
            border-radius: var(--radius);
            padding: 20px;
            border: 1px solid var(--border-color);
        }

        .design-rank {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            margin-bottom: 12px;
        }

        .design-model {
            font-weight: 600;
            font-size: 16px;
            margin-bottom: 8px;
        }

        .design-config {
            font-family: 'Monaco', 'Consolas', monospace;
            background: #e5e7eb;
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 12px;
            display: inline-block;
            margin-bottom: 12px;
        }

        .design-metrics {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            font-size: 12px;
        }

        .design-metric {
            display: flex;
            justify-content: space-between;
        }

        .design-metric-label {
            color: var(--text-secondary);
        }

        .design-metric-value {
            font-weight: 600;
        }

        /* Chart Styles */
        .chart-container {
            background: var(--card-bg);
            padding: 24px;
            border-radius: var(--radius);
            border: 1px solid var(--border-color);
            margin-bottom: 40px;
            max-width: 800px;
            margin-left: auto;
            margin-right: auto;
            margin-bottom: 40px;
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            margin-bottom: 32px;
            flex-wrap: wrap;
            gap: 24px;
        }

        .chart-title {
            font-size: 20px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .chart-controls {
            display: flex;
            gap: 24px;
            align-items: flex-end;
            flex-wrap: wrap;
        }

        .view-toggle {
            display: flex;
            background: #f3f4f6;
            border-radius: 8px;
            padding: 4px;
            gap: 4px;
        }

        .toggle-btn {
            padding: 8px 16px;
            border: none;
            background: transparent;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            color: var(--text-secondary);
            transition: all 0.2s ease;
            font-family: inherit;
        }

        .toggle-btn:hover {
            cursor: pointer;
        }

        .toggle-btn:hover {
            background: #e5e7eb;
            color: var(--text-primary);
        }

        .toggle-btn.active {
            background: var(--card-bg);
            color: var(--text-primary);
            font-weight: 600;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .bar-group {
            cursor: pointer;
            transition: opacity 0.2s;
        }

        .bar-group:hover {
            opacity: 0.85;
            cursor: pointer;
        }

        .bar-individual {
            cursor: pointer;
            transition: all 0.2s;
        }

        .bar-individual:hover {
            opacity: 0.8;
            stroke: #333;
            stroke-width: 2;
            cursor: pointer;
        }

        .paper-btn {
            display: inline-block;
            background: #4A90E2;
            color: white;
            padding: 12px 32px;
            border-radius: 6px;
            text-decoration: none;
            font-weight: 500;
            font-size: 16px;
            transition: all 0.3s ease;
            transform: translateY(0);
            box-shadow: 0 2px 4px rgba(74, 144, 226, 0.2);
            cursor: pointer;
        }

        .paper-btn:hover {
            background: #357ABD;
            color: white;
            text-decoration: none;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(74, 144, 226, 0.3);
        }

        .content-text {
            max-width: 900px;
            margin: 60px auto;
            line-height: 1.8;
            color: var(--text-secondary);
            font-size: 18px;
        }

        .content-text p {
            margin-bottom: 24px;
        }

        .content-text-with-figure {
            max-width: 800px;
            margin: 60px auto;
            line-height: 1.8;
            color: var(--text-secondary);
            font-size: 18px;
            text-align: justify;
        }

        .content-text-with-figure p {
            margin-bottom: 24px;
        }

        .figure-container {
            float: right;
            width: 400px;
            margin: 0 0 20px 20px;
            background: transparent;
            break-inside: avoid;
            shape-outside: margin-box;
        }

        .molecule-figure {
            width: 100%;
            height: 320px;
            background: transparent;
            margin-bottom: 16px;
            position: relative;
            overflow: hidden;
        }

        .molecule-figure > div {
            position: relative !important;
            width: 100% !important;
            height: 100% !important;
        }

        .molecule-figure canvas {
            display: block !important;
            width: 100% !important;
            height: 100% !important;
            position: absolute !important;
            top: 0 !important;
            left: 0 !important;
        }

        .figure-caption {
            font-size: 12px;
            color: var(--text-secondary);
            line-height: 1.4;
            text-align: left;
        }

        .figure-caption strong {
            color: var(--text-primary);
            font-weight: 600;
        }

        @media (max-width: 768px) {
            .figure-container {
                float: none;
                width: 100%;
                margin: 20px 0;
                max-width: 400px;
                margin-left: auto;
                margin-right: auto;
            }

            .content-text-with-figure {
                text-align: left;
            }
        }

        .controls {
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            margin-bottom: 32px;
            flex-wrap: wrap;
            gap: 24px;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .control-label {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .model-toggles {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .model-toggle {
            padding: 6px 12px;
            border: 1px solid transparent;
            background: transparent;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
            transition: all 0.2s ease;
            font-family: inherit;
            color: var(--text-secondary);
        }

        .model-toggle:hover {
            cursor: pointer;
        }

        .model-toggle:hover {
            background-color: rgba(0,0,0,0.05);
            color: var(--text-primary);
        }

        .model-toggle.active {
            font-weight: 600;
            color: white;
        }

        .search-controls {
            display: flex;
            gap: 16px;
            align-items: flex-end;
        }

        .search-box {
            padding: 10px 16px;
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            border-radius: var(--radius);
            font-size: 14px;
            font-weight: 400;
            font-family: inherit;
            min-width: 250px;
            box-shadow: var(--shadow-sm);
            transition: border-color 0.2s;
        }

        .search-box:hover, .search-box:focus {
            border-color: var(--border-hover);
            outline: none;
        }

        .search-box::placeholder {
            color: var(--text-muted);
        }



        /* Responsive Design */
        @media (max-width: 1200px) {
            .container {
                padding: 0 16px;
            }

            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 768px) {
            .controls {
                flex-direction: column;
                align-items: stretch;
            }

            .search-controls {
                flex-direction: column;
                gap: 12px;
            }

            .search-box {
                min-width: auto;
            }

            .table-wrapper {
                max-height: 60vh;
            }

            th, td {
                padding: 12px 16px;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Loading States */
        .loading {
            opacity: 0.6;
            pointer-events: none;
        }

        .loading-spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid var(--text-muted);
            border-radius: 50%;
            border-top-color: var(--text-primary);
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Reference link styling */
        a[href^="#ref"] {
            color: #4A90E2;
            text-decoration: none;
            transition: all 0.2s ease;
        }

        a[href^="#ref"]:hover {
            color: #357ABD;
            text-decoration: underline;
        }

        html {
            scroll-behavior: smooth;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Title -->
        <div style="text-align: center; margin-bottom: 40px;">
            <h1>LLM-Enabled Nanobody Design Results</h1>
        </div>

        <!-- Read Paper Button -->
        <div style="text-align: center; margin-bottom: 60px;">
            <a href="#" id="paperLink" class="paper-btn">Read Full Paper</a>
        </div>

        <!-- Text with 3D Figure -->
        <div class="content-text-with-figure">
            <div class="figure-container">
                <div class="molecule-figure" id="moleculeFigure"></div>
                <div class="figure-caption">
                    <strong>Figure 1:</strong> Nanobody design generated by <strong id="figureModelName">DEEPSEEK REASONER</strong> with ipSAE score of <strong id="figureScore">0.880</strong>. The structure shows the antibody-antigen interface optimized for enhanced binding affinity.
                </div>
            </div>

            <p>We want to build technology that protects us from the biggest threats we will face as a society in the coming decades. To achieve this with high robustness it is important to maintain a balanced portfolio of defensive technologies that both leverage scaling factors like compute, power, and industrial capacity, while maintaining uncorrelated components that function independently of those general improvements.</p>

            <p>Resilience against threats of biological origin is especially relevant due to direct impact on public health. This has been made apparent with the recent concerns about AI-enabled bio-threats <a href="#ref6" style="color: #4A90E2; text-decoration: none;">[6]</a><a href="#ref7" style="color: #4A90E2; text-decoration: none;">[7]</a>. But, what if we could use the power of AI for the benefit of defense?</p>

            <p>To investigate this question, we focus on potential application of AI for Bio Defense, the automated design of pharmacological compounds. Concretely we focus on a type of protein: the nanobodies. Nanobodies (also known as Single Domain Antibodies) are a class of proteins with the ability to bind to specific antigens, much like antibodies, but substantially smaller and simpler.</p>

            <p>Nanobodies offer potential advantages that are highly relevant for situations in which a fast reaction is necessary (like a natural or man-made pandemic). For example, nanobodies have very short development times and don't require specialized equipment to be developed, this is specially relevant when dealing with fastly evolving strains. They also have many drawbacks, which would make mass deployment very challenging.</p>

            <p>There is growing interest in using nanobodies for pharmaceutical applications <a href="#ref5" style="color: #4A90E2; text-decoration: none;">[5]</a><a href="#ref10" style="color: #4A90E2; text-decoration: none;">[10]</a><a href="#ref11" style="color: #4A90E2; text-decoration: none;">[11]</a>.</p>

            <p>In recent years, the tools available to protein engineers have been dramatically expanded by ML-based biological models <a href="#ref12" style="color: #4A90E2; text-decoration: none;">[12]</a><a href="#ref13" style="color: #4A90E2; text-decoration: none;">[13]</a>. This is also true for nanobody design <a href="#ref2" style="color: #4A90E2; text-decoration: none;">[2]</a>. However despite the ease of use of these tools, many aspects of protein design are still poorly understood and rely on diffuse and tacit knowledge that only researchers have.</p>

            <p>This prompts our central question: <strong>"Can we leverage the biological knowledge present in state-of-the-art LLMs to automate the design of nanobodies?"</strong></p>

            <p>To answer this question we evaluate several LLMs on the autonomous design of nanobodies for Nipah virus using RFantibody as a harness. Several in-silico metrics <a href="#ref4" style="color: #4A90E2; text-decoration: none;">[4]</a> will be used to assess the quality of the designed nanobodies.</p>
        </div>

        <!-- Model Filter -->
        <div style="margin-bottom: 40px; text-align: center;">
            <div class="control-group">
                <div class="control-label">Filter Models</div>
                <div class="model-toggles" id="modelToggles"></div>
            </div>
        </div>

        <!-- Histogram Chart -->
        <div class="chart-container">
            <div class="chart-header">
                <h3 class="chart-title">Performance Comparison</h3>
                <div class="chart-controls">
                    <div class="control-group">
                        <div class="control-label">View Mode</div>
                        <div class="view-toggle" id="viewToggle">
                            <button class="toggle-btn active" data-view="average">Model Averages</button>
                            <button class="toggle-btn" data-view="individual">Individual Runs</button>
                        </div>
                    </div>
                    <div class="control-group">
                        <div class="control-label">Metric</div>
                        <select class="metric-select" id="metricSelect"></select>
                    </div>
                </div>
            </div>
            <svg id="chart"></svg>
        </div>

        <!-- References Section -->
        <div class="content-text" style="margin-top: 80px;">
            <h2 style="font-size: 24px; font-weight: 600; margin: 40px 0 20px 0; color: var(--text-primary);">References</h2>
            <ol style="list-style: decimal; padding-left: 20px; line-height: 1.8;">
                <li id="ref1" style="margin-bottom: 16px;"><strong>Adaptyv Bio.</strong> (2025, November 7). <em>The protein design competition is back!</em> Adaptyv Bio Substack. <a href="https://adaptyvbio.substack.com/p/the-protein-design-competition-is" target="_blank" style="color: #4A90E2; text-decoration: none;">Link</a></li>
                <li id="ref2" style="margin-bottom: 16px;"><strong>Bennett, N. R.,</strong> Watson, J. L., Ragotte, R. J., Borst, A. J., See, D. L., Weidle, C., ... & Baker, D. (2025). Atomically accurate de novo design of antibodies with RFdiffusion. <em>Nature</em>, <em>638</em>, 320‚Äì327. <a href="https://doi.org/10.1038/s41586-025-09721-5" target="_blank" style="color: #4A90E2; text-decoration: none;">doi:10.1038/s41586-025-09721-5</a></li>
                <li id="ref3" style="margin-bottom: 16px;"><strong>Bryant, P.,</strong> Pozzati, G., & Elofsson, A. (2022). Improved prediction of protein-protein interactions using AlphaFold2. <em>Nature Communications</em>, <em>13</em>, Article 1664. <a href="https://doi.org/10.1038/s41467-022-28865-w" target="_blank" style="color: #4A90E2; text-decoration: none;">doi:10.1038/s41467-022-28865-w</a></li>
                <li id="ref4" style="margin-bottom: 16px;"><strong>Dunbrack Lab.</strong> (2025). <em>IPSAE: Scoring function for interprotein interactions in AlphaFold2 and AlphaFold3</em> [Computer software]. GitHub. <a href="https://github.com/DunbrackLab/IPSAE" target="_blank" style="color: #4A90E2; text-decoration: none;">Link</a></li>
                <li id="ref5" style="margin-bottom: 16px;"><strong>Lim, H. E.,</strong> Kim, S., & Yoo, H. (2025). Regulation of cellular states via targeted phosphorylation of p53 using a nanobody-coupled kinase system. <em>Cell Death Discovery</em>, <em>11</em>, Article 82. <a href="https://doi.org/10.1038/s41420-025-02821-1" target="_blank" style="color: #4A90E2; text-decoration: none;">doi:10.1038/s41420-025-02821-1</a></li>
                <li id="ref6" style="margin-bottom: 16px;"><strong>Manheim, D.,</strong> Williams, A., Aveggio, C., & Berke, A. (2025). <em>Understanding the theoretical limits of AI-enabled pathogen design</em> (Research Report No. RRA4087-1). RAND Corporation. <a href="https://www.rand.org/pubs/research_reports/RRA4087-1.html" target="_blank" style="color: #4A90E2; text-decoration: none;">Link</a></li>
                <li id="ref7" style="margin-bottom: 16px;"><strong>Norwood, S. A.</strong> (2025, April 15). <em>Understanding AI-enabled biological threats: Hype, hazard, and governance</em>. Cambridge Engineering Biology. <a href="https://www.engbio.cam.ac.uk/news/understanding-ai-enabled-biological-threats-hype-hazard-and-governance" target="_blank" style="color: #4A90E2; text-decoration: none;">Link</a></li>
                <li id="ref8" style="margin-bottom: 16px;"><strong>Novikov, A.,</strong> Vu, N., Eisenberger, M., Dupont, E., Huang, P. S., Wagner, A. Z., ... & Kohli, P. (2025). <em>AlphaEvolve: A coding agent for scientific and algorithmic discovery</em>. arXiv. <a href="https://doi.org/10.48550/arXiv.2506.13131" target="_blank" style="color: #4A90E2; text-decoration: none;">doi:10.48550/arXiv.2506.13131</a></li>
                <li id="ref9" style="margin-bottom: 16px;"><strong>Romera-Paredes, B.,</strong> Barekatain, M., Novikov, A., Balog, M., Kumar, M. P., Dupont, E., ... & Fawzi, A. (2024). Mathematical discoveries from program search with large language models. <em>Nature</em>, <em>625</em>, 468‚Äì475. <a href="https://doi.org/10.1038/s41586-023-06924-6" target="_blank" style="color: #4A90E2; text-decoration: none;">doi:10.1038/s41586-023-06924-6</a></li>
                <li id="ref10" style="margin-bottom: 16px;"><strong>Wang, Z.,</strong> Wu, H., He, W., Wei, S., Wei, X., Wei, C., Wang, Y., & Huang, A. (2025). Protective effect of nanobodies targeting Sip protein against <em>Streptococcus agalactiae</em> infection in Tilapia. <em>Animals</em>, <em>15</em>(21), Article 3207. <a href="https://doi.org/10.3390/ani15213207" target="_blank" style="color: #4A90E2; text-decoration: none;">doi:10.3390/ani15213207</a></li>
                <li id="ref11" style="margin-bottom: 16px;"><strong>Wu, X.,</strong> Zhu, L., Liang, S., Chang, Z., Wang, Y., Zou, Q., ... & Li, M. (2025). A rationally designed cocktail of nanobodies elicited by heterologous vaccination confers protection against SFTSV. <em>Science Translational Medicine</em>, <em>17</em>(825). <a href="https://doi.org/10.1126/scitranslmed.ady9025" target="_blank" style="color: #4A90E2; text-decoration: none;">doi:10.1126/scitranslmed.ady9025</a></li>
                <li id="ref12" style="margin-bottom: 16px;"><strong>Dauparas, J.,</strong> Anishchenko, I., Bennett, N. R., Bai, H., Ragotte, R. J., Milles, L. F., ... & Baker, D. (2022). Robust deep learning‚Äìbased protein sequence design using ProteinMPNN. <em>Science</em>, <em>378</em>(6615), 49‚Äì56. <a href="https://doi.org/10.1126/science.add2187" target="_blank" style="color: #4A90E2; text-decoration: none;">doi:10.1126/science.add2187</a></li>
                <li id="ref13" style="margin-bottom: 16px;"><strong>Jumper, J.,</strong> Evans, R., Pritzel, A., Green, T., Figurnov, M., Ronneberger, O., ... & Hassabis, D. (2021). Highly accurate protein structure prediction with AlphaFold. <em>Nature</em>, <em>596</em>(7873), 583‚Äì589. <a href="https://doi.org/10.1038/s41586-021-03819-2" target="_blank" style="color: #4A90E2; text-decoration: none;">doi:10.1038/s41586-021-03819-2</a></li>
            </ol>
        </div>
    </div>


    <!-- Data -->
    <script src="ipsae_individual_data.js"></script>

    <script>
        // ==================================================================
        // DATA MANAGEMENT & STATE
        // ==================================================================
        let allRuns = [];
        let filteredRuns = [];
        let activeModels = new Set();
        let currentSort = { column: 'ipsae_score', direction: 'desc' };
        let searchTerm = '';
        let currentViewMode = 'average'; // 'average' or 'individual'
        let currentMetric = 'ipSAE';

        // Chart dimensions
        const margin = { top: 30, right: 30, bottom: 60, left: 60 };
        const width = 700 - margin.left - margin.right;
        const height = 350 - margin.top - margin.bottom;


        // Chart SVG
        let chartSvg = null;

        // Figure stage for the inline 3D molecule
        let figureStage = null;

        // ==================================================================
        // INITIALIZE DATA
        // ==================================================================
        function initializeData() {
            // Flatten all runs from all models into a single array
            allRuns = [];

            Object.entries(IPSAE_EVALUATION_DATA.models).forEach(([modelId, modelData]) => {
                activeModels.add(modelId); // Initially all models are active

                modelData.runs.forEach(run => {
                    allRuns.push({
                        ...run,
                        model_name: modelData.name,
                        model_color: modelData.color,
                        hotspot_count: run.hotspots ? run.hotspots.length : 0
                    });
                });
            });

            filteredRuns = [...allRuns];
            console.log(`Initialized with ${allRuns.length} runs from ${Object.keys(IPSAE_EVALUATION_DATA.models).length} models`);
        }

        // ==================================================================
        // INITIALIZE CONTROLS
        // ==================================================================
        function initControls() {
            // Initialize chart SVG
            chartSvg = d3.select('#chart')
                .attr('width', width + margin.left + margin.right)
                .attr('height', height + margin.top + margin.bottom)
                .append('g')
                .attr('transform', `translate(${margin.left},${margin.top})`);

            // View mode toggle
            d3.selectAll('.toggle-btn').on('click', function() {
                const viewMode = d3.select(this).attr('data-view');
                currentViewMode = viewMode;

                d3.selectAll('.toggle-btn').classed('active', false);
                d3.select(this).classed('active', true);

                updateChart();
            });

            // Metric select for chart
            const metricSelect = d3.select('#metricSelect');
            Object.entries(IPSAE_EVALUATION_DATA.metrics).forEach(([id, metric]) => {
                metricSelect.append('option')
                    .attr('value', id)
                    .text(metric.label);
            });
            metricSelect.property('value', currentMetric);
            metricSelect.on('change', function() {
                currentMetric = this.value;
                updateChart();
            });

            // Model toggles
            const modelToggles = d3.select('#modelToggles');
            Object.entries(IPSAE_EVALUATION_DATA.models).forEach(([id, model]) => {
                const btn = modelToggles.append('button')
                    .attr('class', 'model-toggle active')
                    .style('border-color', model.color)
                    .style('background', model.color)
                    .style('color', 'white')
                    .text(model.name)
                    .on('click', function() {
                        const button = d3.select(this);
                        if (activeModels.has(id)) {
                            activeModels.delete(id);
                            button.classed('active', false);
                            button.style('color', model.color);
                            button.style('background', 'transparent');
                        } else {
                            activeModels.add(id);
                            button.classed('active', true);
                            button.style('color', 'white');
                            button.style('background', model.color);
                        }
                        updateChart(); // This should fix the update issue
                    });
            });

        }


        // ==================================================================
        // CHART FUNCTIONS
        // ==================================================================
        function updateChart() {
            if (!chartSvg) return;

            const metric = IPSAE_EVALUATION_DATA.metrics[currentMetric];
            chartSvg.selectAll('*').remove();

            if (currentViewMode === 'average') {
                updateAverageChart();
            } else {
                updateIndividualChart();
            }
        }

        function updateAverageChart() {
            const metric = IPSAE_EVALUATION_DATA.metrics[currentMetric];

            // Calculate averages for each active model
            const modelAverages = [];
            Array.from(activeModels).forEach(modelId => {
                const model = IPSAE_EVALUATION_DATA.models[modelId];
                const values = model.runs.map(run => run[currentMetric]);
                const avg = values.reduce((sum, val) => sum + val, 0) / values.length;

                modelAverages.push({
                    modelId,
                    name: model.name,
                    color: model.color,
                    value: avg,
                    count: values.length
                });
            });

            // Scales
            const x = d3.scaleBand()
                .domain(modelAverages.map(d => d.name))
                .range([0, width])
                .padding(0.3);

            const maxValue = d3.max(modelAverages, d => d.value);
            const y = d3.scaleLinear()
                .domain([0, maxValue * 1.1])
                .range([height, 0]);

            // X axis
            chartSvg.append('g')
                .attr('transform', `translate(0,${height})`)
                .call(d3.axisBottom(x))
                .selectAll('text')
                .attr('fill', '#6b7280')
                .style('font-family', 'Inter, sans-serif')
                .style('font-weight', '500')
                .style('font-size', '10px')
                .attr('transform', 'translate(0, 15)')
                .text(d => d.replace(/\s+/g, ' '));

            // Y axis
            chartSvg.append('g')
                .call(d3.axisLeft(y))
                .selectAll('text')
                .attr('fill', '#6b7280')
                .style('font-family', 'Inter, sans-serif')
                .style('font-weight', '500')
                .style('font-size', '12px');

            // Y axis label
            chartSvg.append('text')
                .attr('transform', 'rotate(-90)')
                .attr('y', -50)
                .attr('x', -height / 2)
                .attr('text-anchor', 'middle')
                .attr('fill', '#6b7280')
                .style('font-family', 'Inter, sans-serif')
                .style('font-weight', '600')
                .style('font-size', '13px')
                .text(metric.label);

            // Bars
            chartSvg.selectAll('.bar')
                .data(modelAverages)
                .join('rect')
                .attr('class', 'bar bar-average')
                .attr('x', d => x(d.name))
                .attr('width', x.bandwidth())
                .attr('y', height)
                .attr('height', 0)
                .attr('fill', d => d.color)
                .attr('rx', 4)
                .transition()
                .duration(750)
                .attr('y', d => y(d.value))
                .attr('height', d => height - y(d.value));

            // Value labels
            chartSvg.selectAll('.value-label')
                .data(modelAverages)
                .join('text')
                .attr('class', 'value-label')
                .attr('x', d => x(d.name) + x.bandwidth() / 2)
                .attr('y', d => y(d.value) - 5)
                .attr('text-anchor', 'middle')
                .style('font-family', 'Inter, sans-serif')
                .style('font-weight', '600')
                .style('font-size', '12px')
                .style('fill', '#374151')
                .text(d => d.value.toFixed(3));
        }

        function updateIndividualChart() {
            const metric = IPSAE_EVALUATION_DATA.metrics[currentMetric];

            // Prepare individual run data
            const individualData = [];
            Array.from(activeModels).forEach(modelId => {
                const model = IPSAE_EVALUATION_DATA.models[modelId];
                model.runs.forEach((run, index) => {
                    individualData.push({
                        modelId,
                        modelName: model.name,
                        color: model.color,
                        value: run[currentMetric],
                        runIndex: index,
                        configId: run.config_id,
                        run: run
                    });
                });
            });

            // Group by model for positioning
            const modelGroups = d3.group(individualData, d => d.modelId);
            const modelNames = Array.from(activeModels).map(id => IPSAE_EVALUATION_DATA.models[id].name);

            // Scales
            const x0 = d3.scaleBand()
                .domain(modelNames)
                .range([0, width])
                .padding(0.2);

            const maxRunsPerModel = d3.max(Array.from(modelGroups.values()), group => group.length);
            const x1 = d3.scaleBand()
                .domain(d3.range(maxRunsPerModel))
                .range([0, x0.bandwidth()])
                .padding(0.05);

            const maxValue = d3.max(individualData, d => d.value);
            const y = d3.scaleLinear()
                .domain([0, maxValue * 1.1])
                .range([height, 0]);

            // X axis
            chartSvg.append('g')
                .attr('transform', `translate(0,${height})`)
                .call(d3.axisBottom(x0))
                .selectAll('text')
                .attr('fill', '#6b7280')
                .style('font-family', 'Inter, sans-serif')
                .style('font-weight', '500')
                .style('font-size', '10px')
                .attr('transform', 'translate(0, 15)')
                .text(d => d.replace(/\s+/g, ' '));

            // Y axis
            chartSvg.append('g')
                .call(d3.axisLeft(y))
                .selectAll('text')
                .attr('fill', '#6b7280')
                .style('font-family', 'Inter, sans-serif')
                .style('font-weight', '500')
                .style('font-size', '12px');

            // Y axis label
            chartSvg.append('text')
                .attr('transform', 'rotate(-90)')
                .attr('y', -50)
                .attr('x', -height / 2)
                .attr('text-anchor', 'middle')
                .attr('fill', '#6b7280')
                .style('font-family', 'Inter, sans-serif')
                .style('font-weight', '600')
                .style('font-size', '13px')
                .text(metric.label);

            // Individual bars
            chartSvg.selectAll('.bar-individual')
                .data(individualData)
                .join('rect')
                .attr('class', 'bar bar-individual')
                .attr('x', d => x0(d.modelName) + x1(d.runIndex))
                .attr('width', x1.bandwidth())
                .attr('y', height)
                .attr('height', 0)
                .attr('fill', d => d.color)
                .attr('rx', 2)
                .transition()
                .duration(750)
                .attr('y', d => y(d.value))
                .attr('height', d => height - y(d.value));
        }

        // ==================================================================
        // 3D MOLECULE FIGURE
        // ==================================================================
        async function initMoleculeFigure() {
            const figureEl = document.getElementById('moleculeFigure');
            console.log('üöÄ Starting molecule figure initialization...');
            console.log('Figure element:', figureEl);
            console.log('Figure element dimensions:', figureEl.offsetWidth, 'x', figureEl.offsetHeight);

            // Find the best scoring antibody design
            let bestRun = null;
            let bestScore = -1;

            console.log('üìä Analyzing IPSAE data...');
            Object.values(IPSAE_EVALUATION_DATA.models).forEach(model => {
                console.log(`Model: ${model.name}, runs: ${model.runs.length}`);
                model.runs.forEach(run => {
                    console.log(`  Run ${run.config_id}: ipSAE = ${run.ipSAE}`);
                    if (run.ipSAE > bestScore) {
                        bestScore = run.ipSAE;
                        bestRun = { ...run, model_name: model.name };
                    }
                });
            });

            console.log(`üèÜ Best run found: ${bestRun?.model_name} with score ${bestScore}`);

            if (!bestRun) {
                console.log('‚ùå No suitable structure found for figure');
                return;
            }

            // Update figure caption with the best run info
            document.getElementById('figureModelName').textContent = bestRun.model_name;
            document.getElementById('figureScore').textContent = bestRun.ipSAE.toFixed(3);

            // Map model names to available structure files
            const structureFileMap = {
                'DeepSeek v3.2': 'structures/openai-api_deepseek-reasoner_best.cif',
                'GPT-5': 'structures/openai_gpt-5_best.cif',
                'GPT 5 MINI': 'structures/openai_gpt-5-mini_best.cif',
                'CLAUDE SONNET 4.0': 'structures/anthropic_claude-sonnet-4-0_best.cif',
                'CLAUDE HAIKU 4.5': 'structures/anthropic_claude-haiku-4-5_best.cif'
            };

            // Get the appropriate structure file
            const structurePath = structureFileMap[bestRun.model_name] || 'structures/anthropic_claude-sonnet-4-0_best.cif';
            console.log(`üìÅ Structure path: ${structurePath}`);

            try {
                console.log('üé¨ Creating NGL Stage...');
                // Create NGL stage for figure
                figureStage = new NGL.Stage(figureEl, {
                    backgroundColor: '#f9fafb',
                    quality: 'high',
                    sampleLevel: 1
                });

                console.log('üé¨ NGL Stage created:', figureStage);
                console.log('üé¨ Viewer:', figureStage.viewer);

                console.log(`üì• Loading structure: ${structurePath}`);

                // Load the best structure
                const component = await figureStage.loadFile(structurePath, {
                    defaultRepresentation: false
                });

                console.log('‚úÖ Figure structure loaded successfully!');
                console.log('üß¨ Component:', component);
                console.log('üß¨ Structure info:', component.structure);

                // Check available methods on the structure object
                console.log('üîç Available structure methods:', Object.getOwnPropertyNames(component.structure));

                // Try different ways to get chain names
                let chainNames = [];
                if (typeof component.structure.getChainnames === 'function') {
                    chainNames = component.structure.getChainnames();
                    console.log('üß¨ Chain names (getChainnames):', chainNames);
                } else if (typeof component.structure.getChainNames === 'function') {
                    chainNames = component.structure.getChainNames();
                    console.log('üß¨ Chain names (getChainNames):', chainNames);
                } else if (component.structure.chainStore) {
                    // Try accessing chain store directly
                    const chainStore = component.structure.chainStore;
                    chainNames = [];
                    for (let i = 0; i < chainStore.count; i++) {
                        chainNames.push(chainStore.getChainname(i));
                    }
                    console.log('üß¨ Chain names (chainStore):', chainNames);
                } else {
                    console.log('üß¨ Using fallback chain names: H, T');
                    chainNames = ['H', 'T']; // Common antibody-antigen chains
                }

                // Try to add a simple representation first to see if anything shows up
                console.log('üé® Adding simple cartoon representation...');
                const repr1 = component.addRepresentation('cartoon', {
                    color: 'chainname'
                });
                console.log('üé® Simple representation added:', repr1);

                // Add representations with more debugging
                console.log('üé® Adding specific chain representations...');
                console.log('Available chains:', chainNames);

                // Add representations for available chains
                if (chainNames.length > 0) {
                    chainNames.forEach((chain, index) => {
                        const color = index === 0 ? '#22c55e' : '#3b82f6';
                        console.log(`Adding representation for chain ${chain} with color ${color}`);
                        try {
                            component.addRepresentation('cartoon', {
                                sele: `:${chain}`,
                                color: color,
                                quality: 'high',
                                opacity: 0.8
                            });
                        } catch (reprError) {
                            console.log(`Failed to add representation for chain ${chain}:`, reprError);
                        }
                    });
                } else {
                    // If no chains detected, just add a general representation
                    console.log('üé® No specific chains detected, adding general representation');
                    component.addRepresentation('cartoon', {
                        color: 'element',
                        quality: 'high'
                    });
                }

                console.log('üéØ Centering view...');
                figureStage.autoView(1000);

                // Force a render to make sure the structure is visible
                setTimeout(() => {
                    figureStage.viewer.requestRender();
                    console.log('üîÑ Forced render after autoView');
                }, 100);

                // Temporarily disable rotation to test if it's causing the issue
                const enableRotation = false; // Set to true to enable rotation

                if (enableRotation) {
                    // Wait a bit before starting rotation to let the view settle
                    setTimeout(() => {
                        console.log('üîÑ Starting gentle rotation...');
                        // Add much slower, gentler rotation
                        function rotateMolecule() {
                            if (figureStage && figureStage.viewer && figureStage.compList.length > 0) {
                                try {
                                    figureStage.viewerControls.rotate([0.002, 0, 0]); // Much slower rotation
                                    figureStage.viewer.requestRender();
                                } catch (rotateError) {
                                    console.log('Rotation error:', rotateError);
                                }
                            }
                        }

                        // Start slower rotation loop
                        setInterval(rotateMolecule, 100); // Rotate every 100ms instead of 50ms
                    }, 2000); // Wait 2 seconds before starting rotation
                } else {
                    console.log('üîÑ Rotation disabled for testing');
                }

                console.log('‚úÖ Molecule figure initialization complete!');

            } catch (error) {
                console.log('‚ùå Figure structure loading failed:', error);
                console.log('üìä Error details:', {
                    name: error.name,
                    message: error.message,
                    stack: error.stack
                });

                // Try fallback structure
                try {
                    console.log('üîÑ Trying fallback structure: 8JA5.cif');

                    // Clean up stage first
                    if (figureStage) {
                        figureStage.removeAllComponents();
                    }

                    const fallbackComponent = await figureStage.loadFile('8JA5.cif', {
                        defaultRepresentation: false
                    });

                    console.log('‚úÖ Fallback structure loaded!');
                    console.log('üß¨ Fallback component:', fallbackComponent);

                    // Just add a simple representation without worrying about specific chains
                    fallbackComponent.addRepresentation('cartoon', {
                        color: 'chainname',
                        quality: 'high',
                        opacity: 0.8
                    });

                    figureStage.autoView(1000);

                    // Add rotation
                    function rotateMolecule() {
                        if (figureStage && figureStage.viewer) {
                            figureStage.viewerControls.rotate([0.01, 0, 0]);
                            figureStage.viewer.requestRender();
                        }
                    }
                    setInterval(rotateMolecule, 50);
                    console.log('‚úÖ Fallback structure visualization complete!');

                } catch (fallbackError) {
                    console.log('‚ùå Fallback structure also failed:', fallbackError);
                    console.log('üìä Fallback error details:', {
                        name: fallbackError?.name || 'Unknown',
                        message: fallbackError?.message || fallbackError?.toString() || 'No error message',
                        stack: fallbackError?.stack || 'No stack trace'
                    });

                    // Try to create a simple test representation
                    try {
                        console.log('üß™ Creating test representation...');
                        figureEl.innerHTML = `
                            <div style="display: flex; align-items: center; justify-content: center; height: 100%; background: linear-gradient(45deg, #e3f2fd, #fff3e0); color: #666; font-size: 14px; text-align: center; padding: 20px;">
                                <div>
                                    <div style="font-weight: bold; margin-bottom: 8px;">üß¨ 3D Molecular Structure</div>
                                    <div style="font-size: 12px;">Structure visualization loading...</div>
                                </div>
                            </div>
                        `;
                    } catch (placeholderError) {
                        console.log('‚ùå Even placeholder failed:', placeholderError);
                    }
                }
            }
        }

        // ==================================================================
        // INITIALIZE APPLICATION
        // ==================================================================
        function init() {
            console.log('Initializing LLM Nanobody Results...');
            initializeData();
            initControls();
            updateChart();

            // Initialize 3D figure after a delay to ensure the DOM is ready
            setTimeout(initMoleculeFigure, 500);

            console.log('‚úÖ Initialization complete!');
        }

        // Start the application when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init);
        } else {
            init();
        }
    </script>
</body>
</html>